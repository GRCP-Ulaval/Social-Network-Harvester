{% load staticfiles %}
{% load extratags %}

<section class="tableContainer">

    {% if source == "YoutubeBase" %}
        <div class="section_menu">
            <span class="section_title">
                <b>Harvested Youtube Channels</b>
            </span>
            <div class="section_options">
                <span>|</span>
                <span class="section_menuItem"><a onclick="addChannelPopup()">Add</a></span>
                <!-- ADD NEW CHANNEL POPUP-->
                <div class="popup" id="addNewChannel">
                    <div id="title">Add new youtube channel</div>
                    <div id="help">
                        Add a new channel to your list of channels to harvest.
                    </div>
                    <div id="content">
                        <form style="max-width:450px;" method="post" action="/youtube/forms/YTAddChannel"
                              enctype="multipart/form-data" id="addChannelPopupForm">
                            {% csrf_token %}
                            <p>Specify all Channels urls:</p>
                            <center>
                                <table>
                                    <tr>
                                    </tr>
                                </table>
                                <br>
                                <div onclick="addChannelLine()" id="addLineButton" style="height:15px; cursor:pointer;">
                                    <img src="{% static 'medias/plus_icon_128.png' %}" style="height:100%;">
                                </div>
                            </center>
                            <hr>
                            <p>Or, select a .csv file:</p>
                            <input type="file" name="Browse" size="chars">
                            <br><br>
                            <center><input type="submit" value="Submit" style="right:0px;"></input></center>
                        </form>
                    </div>
                    <script id="functions">
                        function addChannelLine() {
                            var container = getPopupContainer();
                            container.find('tr').last().after(function () {
                                return $(
                                        '<tr>' +
                                        '<td><input type="text" name="channelURL" placeholder="url" value="" style="width:300px"></td>' +
                                        '</tr>'
                                );
                            });
                            $(".datePicker").datepicker();
                        }
                        function addChannelPopup() {
                            var addLine = lastPopupId != 'addNewChannel';
                            displayCenterPopup('addNewChannel', function () {
                                if (addLine) {
                                    addChannelLine()
                                }
                                ;
                            });
                            $('#centerPopupContent').find("#addChannelPopupForm").unbind('submit');
                            $('#centerPopupContent').find("#addChannelPopupForm").submit(function (event) {
                                event.preventDefault();
                                var formData = new FormData($(this)[0]);
                                $.ajax({
                                    url: $(this).attr("action"),
                                    type: "POST",
                                    data: formData,
                                    processData: false,
                                    contentType: false,
                                    success: function (response) {
                                        $('#centerPopupOutter').hide();
                                        reloadTable('#YTChannelTable')
                                        if (response['status'] == 'ok') {
                                            displayNewMessages(response['messages'])
                                        } else if (response['status'] == 'exception') {
                                            displayNewErrors(response['errors'])
                                        };
                                    }
                                });
                            });
                        }
                    </script>
                </div>
                <span>|</span>
                <span class="section_menuItem"><a onclick="displayRemoveChannelPopup()">Remove</a></span>
                <!-- REMOVE CHANNEL POPUP-->
                <div class="popup" id="removeChannels">
                    <div id="title">Remove</div>
                    <div id="help">
                        Will remove currently selected Youtube channels from your harvesting list.
                    </div>
                    <div id="content">
                        <center>Are you sure you want to remove the <br> selected channels from your list?
                            <br><br>
                            <div id="selectedChannelsNumber">0 lines selected</div>
                            <br>
                            <input type="submit" value="Remove" onclick="submitRemoveChannelsForm()"></input>
                        </center>
                    </div>
                    <script id="functions">
                        function displayRemoveChannelPopup() {
                            lastPopupId = null;
                            var displayer = $('#removeChannels').children('#content').children().children('#selectedChannelsNumber');
                            var length = selectedCounts['#YTChannelTable']
                            if (!length){alert('You must select some rows in the table first.')}
                            else {
                                displayer.html("" + length + " row"+(length>1?"s":"")+ " selected");
                                displayCenterPopup('removeChannels')
                            }

                        }

                        function submitRemoveChannelsForm() {
                            url = '/youtube/removeSelectedItems?pageURL=' +
                                    window.location.pathname+'&tableId=YTChannelTable' +
                                    '&listToRemoveFrom=ytChannelsToHarvest';
                            executeAjaxAndDisplayMessages(url, '#YTChannelTable');
                        }
                    </script>
                </div>
                <span>|</span>
                <span class="section_menuItem">Put in group</span>
                <span>|</span>
                <span id="HashtagHarvester" class="section_menuItem tableDownloader" filename="Harvested_Channels">Download selection
                    <!-- DOWNLOAD FIELDS -->
                    <div class="downloadFields">
                        {% for key,val in 'YTChannel'|getFields %}
                        <div field="{{key}}" helper="{{val.description}}">{{ val.name }}</div>
                        {% endfor %}
                    </div>
                </span>
                <span>|</span>
                <span class="section_menuItem" id="reloadTableLink">Reload table</span>
            </div>
            <div class="tableOpenCloseIcon" type="plus">
                <img src="{% static 'medias/plus_icon_128.png' %}" style="height:100%;">
            </div>
        </div>
        <div class="section_content">
        <table class="display" id="YTChannelTable" width="100%" drawn='False'>
            <thead>
            <tr>
                <th><input type="checkbox" class='table_select_master'></input></th>
                <th>Title</th>
                <th>Video count</th>
                <th>Subscriber count</th>
                <th>Video count</th>
                <th>View count</th>
            </tr>
            </thead>
            <script class="tableVars">
                var fields = "title,videoCount,subscriberCount,videoCount,viewCount";
                var url = "/youtube/ajax?tableId=YTChannelTable";
                var GETValues
                var columnsDefs = [
                    {
                        "orderable": false,
                        "className": 'select-checkbox',
                        "targets": 0,
                        "render": function () {
                            return ""
                        }
                    },
                    {
                        "targets": 1,
                        "asSorting": default_asSorting,
                        "render": function (data, type, row) {
                            return '<a href="/youtube/channel/' + row['title'] + '" class="TableToolLink">' + row['title'] + '</a>';
                        }
                    },
                    {
                        "targets": 2,
                        "asSorting": default_asSorting,
                        "render": function (data, type, row) {
                            return row['videoCount'];
                        }
                    },
                    {
                        "targets": 3,
                        "asSorting": default_asSorting,
                        "render": function (data, type, row) {
                            return row['subscriberCount'];
                        }
                    },
                    {
                        "targets": 4,
                        "asSorting": default_asSorting,
                        "render": function (data, type, row) {
                            return row['videoCount'];
                        }
                    },
                    {
                        "targets": 5,
                        "asSorting": default_asSorting,
                        "render": function (data, type, row) {
                            return row['viewCount'];
                        }
                    },
                ]
            </script>
        </table>
    </div>

    {% endif %}
</section>