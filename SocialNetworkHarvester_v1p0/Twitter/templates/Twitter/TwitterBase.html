{% extends "MainPage.html" %}
{% load staticfiles %}

{% block Title %}SNH | Twitter{% endblock %}

{% block extendHead %}
    <link rel="stylesheet" type="text/css" href='{% static "css/table_style.css" %}' name="style">
    <script type="text/javascript" src='{% static "js/table_script.js" %}'></script>
{% endblock %}

{% block content %}
<section class="overviewContainer yetToCome">
    <div class="section_menu">
        <span class="section_title">
            <b>Overview</b>
        </span>
    </div>
    <div class="section_overview_content">
        -- STATISTIQUES DIVERSES --
    </div>
</section>

<!-- USERS -->
<section class="tableContainer">
    <div class="section_menu">
        <span class="section_title">
            <b>Harvested Users</b>
        </span>
        <div class="section_options">
            <span>|</span>
            <span id="new_user" class="section_menuItem"><a onclick="displayCenterPopup('addNewTwitterUser')">Add</a></span>
            <!-- ADD NEW TWUSER POPUP-->
            <div class="popup" id="addNewTwitterUser">
                <div id="title">Add new Twitter users</div>
                <div id="help">
                    Add Twitter users to your Aspira account by writing down their screen-names,
                    or by uploading a .csv file, where each line corresponds to a user's screen-name
                </div>
                <div id="content">
                    <form style="max-width:450px;" method="post" action="/twitter/addUser" enctype="multipart/form-data">
                        {% csrf_token %}
                        <p>Write all "screen names":</p>
                        <center>
                            <input id='slot_1' type="text" name="screen_name" placeholder="screen_name" value="">
                            <br><br>
                            <div onclick="addUserLine(this)">
                                <img src="{% static 'medias/plus_icon_128.png' %}" style="height:15px; cursor:pointer;">
                            </div>
                        </center>
                        <hr>
                        <p>Or, select a .csv file:</p>
                        <input type="file" name="Browse" size="chars">
                        <br><br>
                        <center><input type="submit" value="Submit" style="right:0px;"></input></center>
                    </form>
                </div>
                <script id="functions">
                    function addUserLine(elem){
                        $(elem).parent().children('input').last().after(function(){
                            return $("<input type='text' name='screen_name' placeholder='screen_name'>");
                        });
                    }
                </script>
            </div>
            <span>|</span>
            <span id="delete_user" class="section_menuItem"><a onclick="removeSelectedUsers()">Remove</a></span>
            <!-- REMOVE TWUSER POPUP-->
            <div class="popup" id="removeTwitterUser">
                <div id="title">Remove</div>
                <div id="help">
                    Will remove currently selected Twitter Users from your Aspira's list. They will no be deleted from the database and you will still be able to see their Tweets. Only, they will not appear in your "Harvested Users" list anymore.
                </div>
                <div id="content">
                    <center>Are you sure you want to remove the <br> selected Twitter users from your list?
                        <br><br>
                        <div id="selectedTWUsers">0 lines selected</div>
                        <br>
                        <input type="submit" value="Remove" onclick="submitForm()"></input>
                    </center>
                </div>
                <script id="functions">
                    function removeSelectedUsers(){
                        lastPopupId = null;
                        var displayer = $('#removeTwitterUser').children('#content').children().children('#selectedTWUsers');
                        var length = filterSelectedTableRows('TWUser').length
                        displayer.html(""+length+" lines selected");
                        displayCenterPopup('removeTwitterUser')
                    }

                    function submitForm(){
                        var ref = '/twitter/removeItem?selectedTableRows=';
                        filterSelectedTableRows('TWUser').forEach(function (item) {
                            ref += item + ',';
                        })
                        window.location.href = ref;
                    }
                </script>
            </div>
            <span>|</span>
            <span id="add_to_group" class="section_menuItem">Put in group</span>
            <span>|</span>
            <span id="TWUser" class="section_menuItem tableDownloader">Download selection
                <!-- DOWNLOAD FIELDS -->
                <div class="downloadFields">
                    <div field="screen_name" helper="Identifier name of the user's account.">Screen Name</div>
                    <div field="name" helper="Full name of the user.">Name</div>
                    <div field="_ident" helper="Identifier number of the account.">Identifier</div>
                    <div field="created_at" helper="Time of creation of the account.">Created at</div>
                    <div field="geo_enabled" helper="(Boolean) Wheter the account as geo-location enabled.">Geo-Enabled</div>
                    <div field="has_extended_profile" helper="(Boolean) Whether or not the account has an extended profile.">Extended Profile</div>
                    <div field="is_translator" helper="(Boolean) Whether or not the user is part of the Twitter's translators community.">Is Translator</div>
                    <div field="lang" helper="Primary language of the account.">Language</div>
                    <div field="location" helper="Geolocation of the user. May not be a exact field as users choose what they write.">Location</div>
                    <div field="protected" helper="(Boolean) Whether or not the user allows its account to be harvested via the API.">Protected</div>
                    <div field="verified" helper="(Boolean) Whether or not the account has been authenticated as legit by the Twitter staff.">Verified</div>
                    <div field="time_zone" helper="Time zone of the account location.">Time Zone</div>
                    <div field="url" helper="Website of the user, or organisation.">URL</div>
                    <div field="description" helper="Description of the account.">Description</div>
                    <div field="statuses_count" helper="Number of statuses as of the last harvest.">Statuses count</div>
                    <div field="favourites_count" helper="Number of favorite Tweets as of the last harvest.">Favorite count</div>
                    <div field="followers_count" helper="Number of followers of the account as of the last harvest.">Followers count</div>
                    <div field="friends_count" helper="Number of accounts followed by this user as of the last harvest.">Friends count</div>
                    <div field="listed_count" helper="Number of Twitter's public lists that the user is part of.">Listed count</div>
                </div>
            </span>
            <span>|</span>
            <span id="reloadTableLink" class="section_menuItem">Reload table</span>
        </div>
        <div class="tableOpenCloseIcon" type="plus">
            <img src="{% static 'medias/plus_icon_128.png' %}" style="height:100%;">
        </div>
    </div>

    <div class="section_content">
        <table class="display" id="twUser_table" width="100%" drawn='False'>
            <thead>
                <tr>
                    <th><input type="checkbox" class='table_select_master'></input></th>
                    <th>Name</th>
                    <th>Screen Name</th>
                    <th>Follower count</th>
                    <th>Friend count</th>
                    <th>Status count</th>
                    <th>Location</th>
                </tr>
            </thead>
            <script class="tableVars">
                var fields = "name,screen_name,followers_count,friends_count,statuses_count,location";
                var url = "/twitter/TWUserTable/{{user.id}}/";
                var columnsDefs = [
                    {
                        "orderable": false,
                        "searchable": false,
                        "className": 'select-checkbox',
                        "targets":   0,
                        "render":function(){return ""}
                    },
                    {
                        "targets":   1,
                        "asSorting": default_asSorting,
                        "render":function(data,type,row){
                            if (row['name'] == null){return '<i>undefined</i>'}
                            else {return row['name']};
                        }
                    },
                    {
                        "targets":   2,
                        "asSorting": default_asSorting,
                        "render":function(data,type,row){
                            if (row['screen_name']==null){return '<i>undefined</i>'} else {
                                return '<a href="/twitter/user/' + row['screen_name'] + '" class="TableToolLink snippetHover">' + row['screen_name'] + '</a>';
                            }
                        }
                    },
                    {
                        "targets":   3,
                        "searchable": false,
                        "asSorting": default_asSorting,
                        "render":function(data,type,row){
                            if (row['followers_count'] == null){return '<i>undefined</i>'}
                            else {return row['followers_count']};
                        }
                    },
                    {
                        "targets":   4,
                        "searchable": false,
                        "asSorting": default_asSorting,
                        "render":function(data,type,row){
                            if (row['friends_count'] == null){return '<i>undefined</i>'}
                            else {return row['friends_count']};
                        }
                    },
                    {
                        "targets":   5,
                        "searchable": false,
                        "asSorting": default_asSorting,
                        "render":function(data,type,row){
                            if (row['statuses_count'] == null){return '<i>undefined</i>'}
                            else {return row['statuses_count']};
                        }
                    },
                    {
                        "targets":   6,
                        "asSorting": default_asSorting,
                        "render":function(data,type,row){
                            if (row['location'] == ''){return '<i>undefined</i>'}
                            else {return row['location']};
                        }
                    },
                ]
            </script>
        </table>
    </div>
</section>

<!-- HASHTAGS -->
<section class="tableContainer">
    <div class="section_menu">
        <span class="section_title">
            <b>Harvested Hashtags</b>
        </span>
        <div class="section_options">
            <span>|</span>
            <span class="section_menuItem"><a onclick="addAshtagPopup()">Add</a></span>
            <!-- ADD NEW HASHTAG POPUP-->
            <div class="popup" id="addNewHashtag">
                <div id="title">Add new Hashtag</div>
                <div id="help">
                    Add a new hashtag to your list of hashtags to harvest. Can begin with or without the "#" character.
                    A starting and ending date must be provided for each hashtag term. These corresponds to the time-span
                    in wich the Tweets will be harvested. If the CSV method is used, each line MUST be in the following
                    format:
                    <br><br>
                    <center>
                        term,start_date,end_date
                    </center>
                    <br>
                    Where start_date < end_date and both are in the format MM/DD/YYYY.
                </div>
                <div id="content">
                    <form style="max-width:450px;" method="post" action="/twitter/addHashtag"
                          enctype="multipart/form-data">
                        {% csrf_token %}
                        <p>Specify all Hastags:</p>
                        <center>
                            <table>
                                <tr>
                                    <td>Term</td>
                                    <td>Start date</td>
                                    <td>End date</td>
                                </tr>
                                <!--tr>
                                    <td><input type="text" name="hashtag_1" placeholder="Term" value=""></td>
                                    <td><input type="text" name="start_1" class="datePicker"></td>
                                    <td><input type="text" name="end_1" class="datePicker"></td>
                                </tr-->
                            </table>
                            <br>
                            <div onclick="addHashtagLine()" id="addLineButton" style="height:15px; cursor:pointer;">
                                <img src="{% static 'medias/plus_icon_128.png' %}" style="height:100%;">
                            </div>
                        </center>
                        <hr>
                        <p>Or, select a .csv file:</p>
                        <input type="file" name="Browse" size="chars">
                        <br><br>
                        <center><input type="submit" value="Submit" style="right:0px;"></input></center>
                    </form>
                </div>
                <script id="functions">
                    function addHashtagLine() {
                        var container = getPopupContainer();
                        container.find('tr').last().after(function () {
                            return $(
                                '<tr>' +
                                    '<td><input type="text" name="hashtags" placeholder="Term" value=""></td>' +
                                    '<td><input type="text" name="starts" class="datePicker"></td> ' +
                                    '<td><input type="text" name="ends" class="datePicker"></td>' +
                                '</tr>'
                            );
                        });
                        $(".datePicker").datepicker();
                    }
                    function addAshtagPopup(){
                        var addLine = lastPopupId != 'addNewHashtag';
                        displayCenterPopup('addNewHashtag', function(){
                            if(addLine){addHashtagLine()};
                        });
                    }
                </script>
            </div>
            <span>|</span>
            <span class="section_menuItem"><a onclick="displayRemoveHashtagsPopup()">Remove</a></span>
            <!-- REMOVE HASHTAG POPUP-->
            <div class="popup" id="removeHashtags">
                <div id="title">Remove</div>
                <div id="help">
                    Will remove currently selected Hashtags from your Aspira's list. They will no be deleted from
                    the database and you will still be able to see the tweets containing them. Only, they will not
                    appear in your "Harvested Hashtags" list anymore.
                </div>
                <div id="content">
                    <center>Are you sure you want to remove the <br> selected Hashtags from your list?
                        <br><br>
                        <div id="selectedHashtagsNumber">0 lines selected</div>
                        <br>
                        <input type="submit" value="Remove" onclick="submitRemoveHashtagForm()"></input>
                    </center>
                </div>
                <script id="functions">
                    function displayRemoveHashtagsPopup() {
                        lastPopupId = null;
                        var displayer = $('#removeHashtags').children('#content').children().children('#selectedHashtagsNumber');
                        var length = filterSelectedTableRows('HashtagHarvester').length
                        displayer.html("" + length + " lines selected");
                        displayCenterPopup('removeHashtags')
                    }

                    function submitRemoveHashtagForm() {
                        var ref = '/twitter/removeItem?selectedTableRows=';
                        filterSelectedTableRows('HashtagHarvester').forEach(function (item) {
                            ref += item + ',';
                        })
                        window.location.href = ref;
                    }
                </script>
            </div>
            <span>|</span>
            <span class="section_menuItem">Add to group</span>
            <span>|</span>
            <span id="HashtagHarvester" class="section_menuItem tableDownloader">Download selection</span>
            <span>|</span>
            <span class="section_menuItem">Reload table</span>
        </div>
        <div class="tableOpenCloseIcon" type="plus">
            <img src="{% static 'medias/plus_icon_128.png' %}" style="height:100%;">
        </div>
    </div>

    <div class="section_content">
        <table class="display" id="twHashtags_table" width="100%" drawn='False'>
            <thead>
                <tr>
                    <th><input type="checkbox" class='table_select_master'></input></th>
                    <th>Term</th>
                    <th>Hit count</th>
                    <th>Harvest since</th>
                    <th>Harvest until</th>
                </tr>
            </thead>
            <script class="tableVars">
                var fields = "hashtag__term,hashtag__hit_count,_harvest_since,_harvest_until";
                var url = "/twitter/TWHashtagTable/{{user.id}}/";
                var columnsDefs = [
                    {
                        "orderable": false,
                        "className": 'select-checkbox',
                        "targets":   0,
                        "render":function(){return ""}
                    },
                    {
                        "targets":   1,
                        "asSorting": default_asSorting,
                        "render":function(data,type,row){
                            return '<a href="/twitter/hashtag/'+row['hashtag__term']+'" class="TableToolLink">'+row['hashtag__term']+'</a>';
                        }
                    },
                    {
                        "targets":   2,
                        "orderable": false,
                        "render":function(data,type,row){
                            return row['hashtag__hit_count'];
                        }
                    },
                    {
                        "targets": 3,
                        "asSorting": default_asSorting,
                        "render": function (data, type, row) {
                            return row['_harvest_since'];
                        }
                    },
                    {
                        "targets": 4,
                        "asSorting": default_asSorting,
                        "render": function (data, type, row) {
                            return row['_harvest_until'];
                        }
                    },
                ]
            </script>
        </table>
    </div>
</section>

<!-- TWEETS -->
<section class="tableContainer">
    <div class="section_menu">
        <span class="section_title">
            <b>Tweets</b>
        </span>
        <div class="section_options">
            <span>|</span>
            <span id="Tweet" class="section_menuItem tableDownloader">Download selection</span>
            <span>|</span>
            <span id="reloadTableLink" class="section_menuItem">Reload table</span>
            <span>|</span>
            <span><input type="checkbox" name="exclude_retweets" class="option_checkbox"> Exclude retweets</span>
        </div>
        <div class="tableOpenCloseIcon" type="plus">
            <img src="{% static 'medias/plus_icon_128.png' %}" style="height:100%;">
        </div>
    </div>

    <div class="section_content">
        <table class="display" id="tweet_table" width="100%" drawn='False'>
            <thead>
                <tr>
                    <th><input type="checkbox" class='table_select_master'></input></th>
                    <th>Date</th>
                    <th>Author</th>
                    <th>Text</th>
                    <th>Retweets</th>
                    <th></th>
                </tr>
            </thead>
            <script class="tableVars">
                var fields = "created_at,user,text,retweet_count,_ident";
                var dynamicSource=true;
                var url="/twitter/TWTweetTable/";
                var languageParams = {
                        "zeroRecords": "Select some rows in the tables above, then reload this table.",
                        "thousands":",",
                    };
                var columnsDefs = [
                    {
                        "orderable": false,
                        "className": 'select-checkbox',
                        "targets":   0,
                        "render":function(){return ""}
                    },
                    {
                        "targets":   1,
                        "searchable": false,
                        "asSorting": default_asSorting,
                        "render":function(data,type,row){
                            if (row['created_at'] == null) {return "<i>undefined</i>"}
                            return row['created_at'];
                        }
                    },
                    {
                        "targets":   2,
                        "searchable": true,
                        "asSorting": default_asSorting,
                        "render":function(data,type,row){
                            if (row['user'] == null) {return "<i>undefined</i>"}
                            return '<a href="/twitter/user/'+row['user']+'" class="TableToolLink snippetHover">'+row['user']+'</a>';
                        }
                    },
                    {
                        "targets":   3,
                        "asSorting": default_asSorting,
                        "render":function(data,type,row){
                            return formatTweetText(row['text']);
                        }
                    },
                    {
                        "targets":   4,
                        "asSorting": default_asSorting,
                        "render":function(data,type,row){
                            if(row['retweet_count']==null) {return "<i>undefined</i>"}
                            return row['retweet_count'];
                        }
                    },
                    {
                        "targets":   5,
                        "searchable": false,
                        "orderable": false,
                        "render":function(data,type,row){
                            return '<a href="/twitter/tweet/'+row["_ident"]+'" class="TableToolLink">'+'more infos'+'</a>';
                        }
                    },
                ];
            </script>
        </table>
    </div>
</section>

{% endblock %}

















































